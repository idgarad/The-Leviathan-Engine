# Garage S3-Compatible Backend Setup Guide (Terraform State Management)

## Tool Overview
Garage is a lightweight, modern, self-hosted S3-compatible object store. It supports multi-user keys, versioning, and can be used as a backend for Terraform state files.

- **Role:** Provides S3 API storage for Terraform state, with support for multiple keys and buckets.
- **References:**
  - [Garage Official Docs](https://garagehq.deuxfleurs.fr/documentation/)
  - [Terraform S3 Backend](https://developer.hashicorp.com/terraform/language/settings/backends/s3)
  - Book: "Infrastructure as Code" by Kief Morris
  - YouTube: "Garage Object Store Overview" (Deuxfleurs channel)

---

## Step 1: Choose Deployment Method

**VM vs LXC Container:**
- Garage can run in either a VM or an LXC container. For most homelabs, an LXC container is lighter and easier to manage, but ensure you enable nesting and required kernel features.
- For maximum isolation and compatibility, a VM is safest, but uses more resources.
- See [Garage Container Guide](https://garagehq.deuxfleurs.fr/documentation/container/) for details.

---

## Step 2: Install Garage

### On Ubuntu (VM or LXC):
```bash
curl -fsSL https://garagehq.deuxfleurs.fr/install.sh | bash
sudo systemctl enable garage
sudo systemctl start garage
```

---

## Step 3: Initialize Garage and Generate Keys

1. **Initialize Garage cluster (single node):**
   ```bash
   garage setup
   # Follow prompts to set up data directory and node identity
   ```
2. **Generate admin key:**
   ```bash
   garage key generate --name admin
   # Save the output securely
   ```
3. **Create S3 user and access keys:**
   ```bash
   garage user create terraform
   garage key generate --name terraform --user terraform
   # Note the access key and secret key output
   ```
4. **Create bucket for Terraform state:**
   ```bash
   garage bucket create terraform-state --owner terraform
   ```

---

## Step 4: Configure Firewall and Networking
- Open port 3900 (Garage API/S3 endpoint) on your host/container.
- Restrict access to trusted hosts only.

---

## Step 5: Configure Terraform Backend

In your Terraform project:
```hcl
terraform {
  backend "s3" {
    endpoint   = "http://<garage-host>:3900"
    bucket     = "terraform-state"
    key        = "terraform.tfstate"
    access_key = "<access-key>"
    secret_key = "<secret-key>"
    region     = "garage"
    skip_credentials_validation = true
    skip_metadata_api_check     = true
    force_path_style            = true
  }
}
```

---

## Step 6: Maintenance and Best Practices
- Enable bucket versioning for state file recovery:
  ```bash
  garage bucket versioning terraform-state enable
  ```
- Regularly back up Garage data directory.
- Monitor Garage logs and health.
- Rotate keys and credentials as needed.

---

## Practical Advice
- For LXC: Use Ubuntu template, enable nesting, and mount a dedicated storage volume for Garage data.
- For VM: Allocate at least 2GB RAM and a fast disk for Garage data.
- Garage is best for small clusters and homelabs; for large-scale, consider distributed deployment.

---

## Update Notice
Instructions accurate as of October 2025. For updates, see official docs.

## Further Reading
- [Garage S3 Backend](https://garagehq.deuxfleurs.fr/documentation/terraform/)
- Book: "Terraform: Up & Running" by Yevgeniy Brikman
