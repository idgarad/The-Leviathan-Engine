# Consul + Nomad Homelab Deployment Guide (Terraform State & Orchestration)

## Tool Overview
Consul and Nomad are HashiCorpâ€™s open-source tools for service discovery, configuration, and workload orchestration. Together, they provide a modern, production-like automation platform for homelabs.

- **Consul:** Service discovery, health checking, key-value store, and Terraform state backend.
- **Nomad:** Flexible workload orchestrator for containers, VMs, and standalone apps. Integrates with Consul for service registration and health.

**References:**
- [Consul Official Docs](https://www.consul.io/docs)
- [Nomad Official Docs](https://www.nomadproject.io/docs)
- Book: "Infrastructure as Code" by Kief Morris
- Book: "Terraform: Up & Running" by Yevgeniy Brikman
- YouTube: HashiCorp Consul & Nomad Deep Dive (HashiCorp channel)

---

## Step 1: Install Consul

**Where to Install:**
- **Proxmox hosts (e.g., pve1, pve2):** Install Consul and configure as server nodes (`server = true`). These maintain cluster state and provide high availability.
- **VMs/containers:** Install Consul as agent (client mode, default). These register services and participate in service discovery.

On Ubuntu (Proxmox host, VM, or container):
```bash
sudo apt update
sudo apt install unzip
wget https://releases.hashicorp.com/consul/1.16.2/consul_1.16.2_linux_amd64.zip
unzip consul_1.16.2_linux_amd64.zip
sudo mv consul /usr/local/bin/
consul --version
```

---

## Step 2: Install Nomad

**Where to Install:**
- **Proxmox hosts (e.g., pve1, pve2):** Install Nomad and configure as server nodes (`server = true`). These coordinate job scheduling and cluster state. For HA, use an odd number of servers (usually 3, but 2 is acceptable for small homelabs).
- **VMs/containers:** Install Nomad as client nodes (`server = false`, default). These execute workloads scheduled by Nomad servers.

On Ubuntu (Proxmox host, VM, or container):
```bash
wget https://releases.hashicorp.com/nomad/1.7.4/nomad_1.7.4_linux_amd64.zip
unzip nomad_1.7.4_linux_amd64.zip
sudo mv nomad /usr/local/bin/
nomad --version
```

---

## Step 3: Start Consul Agent (Single Node)

**Where to Run:**
- **Proxmox hosts (e.g., pve1, pve2):** Start Consul in server mode:
  ```bash
  consul agent -server -bootstrap-expect 2 -node=pve1 -client=0.0.0.0
  # Repeat for pve2, changing node name
  ```
  Or use config file:
  ```hcl
  server = true
  bootstrap_expect = 2
  node_name = "pve1"
  client_addr = "0.0.0.0"
  ```
- **VMs/containers:** Start Consul in agent (client) mode (default):
  ```bash
  consul agent -node=<vmname> -client=0.0.0.0
  ```

- For production, configure a multi-node cluster (see Consul docs).

---

## Step 4: Start Nomad Agent (Single Node)

**Where to Run:**
- **Proxmox hosts (e.g., pve1, pve2):** Start Nomad in server mode:
  ```bash
  nomad agent -server -bootstrap-expect=2 -node=pve1 -bind=0.0.0.0
  # Repeat for pve2, changing node name
  ```
  Or use config file:
  ```hcl
  server {
    enabled = true
    bootstrap_expect = 2
  }
  node_name = "pve1"
  bind_addr = "0.0.0.0"
  ```
- **VMs/containers:** Start Nomad in client mode (default):
  ```bash
  nomad agent -client -node=<vmname> -bind=0.0.0.0
  ```
  Or use config file:
  ```hcl
  client {
    enabled = true
  }
  node_name = "<vmname>"
  bind_addr = "0.0.0.0"
  ```

- Nomad clients will register with Nomad servers and execute scheduled jobs.
- For production, configure Nomad server/client roles and join to Consul cluster.

---

## Step 5: Integrate Consul and Nomad

- By default, Nomad will auto-detect Consul if running locally.
- For custom configs, set Consul address in Nomad config (`/etc/nomad.d/nomad.hcl`):
  ```hcl
  consul {
    address = "127.0.0.1:8500"
  }
  ```
- Nomad jobs can register services in Consul for discovery and health checks.

---

## Step 6: Configure Terraform Backend (Consul)

**Where to Configure:**
- Use the Consul backend in your Terraform project directory (on your admin workstation or wherever you run Terraform).
- The Consul server/agent must be reachable from your Terraform client.

```hcl
terraform {
  backend "consul" {
    address = "127.0.0.1:8500"
    path    = "terraform/state"
    scheme  = "http"
  }
}
```

---

## Step 7: Deploy a Sample Nomad Job

**Where to Run:**
- Submit jobs from your admin workstation, or directly on the Nomad server node.
- Jobs will be scheduled on Nomad clients (Proxmox host, VMs, containers) as configured.

Example: Run a simple web server container
```hcl
job "web" {
  datacenters = ["dc1"]
  group "web" {
    task "nginx" {
      driver = "docker"
      config {
        image = "nginx:latest"
        port_map {
          http = 80
        }
      }
      resources {
        cpu    = 100
        memory = 128
        network {
          port "http" {}
        }
      }
      service {
        name = "nginx"
        port = "http"
        tags = ["web"]
        check {
          type     = "http"
          path     = "/"
          interval = "10s"
          timeout  = "2s"
        }
      }
    }
  }
}
```
Submit with:
```bash
nomad job run web.nomad
```

---

## Validation Checks

After each major setup step, use these checks to confirm everything is working before moving on:

### 1. Validate Consul Installation & Service
```bash
consul --version
systemctl status consul
consul members
```
- Expected: Consul version prints, service is active, and members list shows your node(s).

### 2. Validate Nomad Installation & Service
```bash
nomad --version
systemctl status nomad
nomad node status
```
- Expected: Nomad version prints, service is active, and node status lists your Nomad server/client.

### 3. Validate Consul Cluster Health
```bash
consul info | grep leader
consul members
```
- Expected: One node is elected leader, all server/agent nodes are listed as alive.

### 4. Validate Nomad Cluster Health
```bash
nomad server members
nomad node status
```
- Expected: Nomad servers are listed and reachable, clients are registered.

### 5. Validate Service Registration (Sample Job)
After submitting a Nomad job:
```bash
nomad job status web
consul catalog services
```
- Expected: Job status is running, service appears in Consul catalog.

### 6. Validate Web UI Access (Optional)
- Consul UI: http://<host>:8500
- Nomad UI: http://<host>:4646
- Expected: Web interfaces load and show cluster status.

---

**If any check fails:**
- Review logs with `journalctl -u consul` or `journalctl -u nomad`.
- Check config files for errors.
- Ensure network/firewall rules allow communication between nodes.

---

## Step 8: Maintenance & Best Practices
- Secure Consul and Nomad with ACLs and TLS for sensitive environments.
- Regularly back up Consul data and Nomad job files.
- Monitor service health and logs.
- Use Consul KV store for dynamic config and secrets.
- Experiment with multi-node clusters for high availability.
- Ensure Nomad servers are on reliable, always-on nodes (physical hosts preferred).
- Nomad clients can be added/removed dynamically for flexible scaling.

---

## Step 9: Run Consul and Nomad as Systemd Services

**Why:**
Running Consul and Nomad as systemd services ensures they start automatically on boot, restart on failure, and can be managed with standard systemctl commands. This is the recommended approach for production and homelab reliability.

### Example: Consul systemd unit file
Create `/etc/systemd/system/consul.service`:
```ini
[Unit]
Description=Consul Agent
Requires=network-online.target
After=network-online.target

[Service]
User=root
Group=root
ExecStart=/usr/local/bin/consul agent -config-dir=/etc/consul.d/
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```

### Example: Nomad systemd unit file
Create `/etc/systemd/system/nomad.service`:
```ini
[Unit]
Description=Nomad Agent
Requires=network-online.target
After=network-online.target

[Service]
User=root
Group=root
ExecStart=/usr/local/bin/nomad agent -config=/etc/nomad.d/
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```

### Enable and start services
```bash
sudo systemctl daemon-reload
sudo systemctl enable consul
sudo systemctl start consul
sudo systemctl enable nomad
sudo systemctl start nomad
```

**Note:**
- Adjust `User` and `Group` as needed for your environment.
- Ensure your config files are in `/etc/consul.d/` and `/etc/nomad.d/`.
- Check service status with `systemctl status consul` and `systemctl status nomad`.

---

## Update Notice
Instructions accurate as of October 2025. For updates, see official docs.

## Further Reading
- [Consul + Nomad Integration](https://learn.hashicorp.com/collections/nomad/getting-started)
- [Nomad Tutorials](https://developer.hashicorp.com/nomad/tutorials)
- Book: "Infrastructure as Code" by Kief Morris
