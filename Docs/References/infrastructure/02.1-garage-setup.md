# Garage S3-Compatible Backend Setup Guide (Terraform State Management)

## Tool Overview
Garage is a lightweight, modern, self-hosted S3-compatible object store. It supports multi-user keys, versioning, replication, and can serve as a Terraform state backend.

- **Role:** Provides S3 API storage for Terraform state with granular key management and bucket controls.
- **References:**
  - [Garage Official Docs](https://garagehq.deuxfleurs.fr/documentation/)
  - [Terraform S3 Backend](https://developer.hashicorp.com/terraform/language/settings/backends/s3)
  - Book: "Infrastructure as Code" by Kief Morris
  - Book: "Terraform: Up & Running" by Yevgeniy Brikman
  - YouTube: "Garage Object Store Overview" (Deuxfleurs channel)

---

## Step 1: Plan Deployment & Prerequisites

- **Host Selection:** LXC container (lighter, ensure nesting + required kernel modules) or VM (full isolation, higher resource use).
- **Storage:** Mount dedicated volume for `/var/lib/garage` (ext4/XFS). Provide SSD or fast disk for reliability.
- **Networking:** Reserve static IP/DNS entry, open TCP 3900 (S3 API) and 3901 (admin) if needed. Segment network access to trusted Terraform clients.
- **Packages:** Install `curl`, `unzip`, and ensure `systemd` is available for service management.

---

## Step 2: Install Garage Binary

```bash
curl -fsSL https://garagehq.deuxfleurs.fr/install.sh | bash
sudo install -o root -g root -m 0755 garage /usr/local/bin/garage
garage --version
```

Optional: download specific release tarball and verify checksum per official docs.

---

## Step 3: Configure Storage & Directories

```bash
sudo mkdir -p /etc/garage /var/lib/garage
sudo chown -R garage:garage /var/lib/garage  # if running under dedicated user
```

Create `/etc/garage/config.toml` (single-node example):

```toml
[metadata]
data_dir = "/var/lib/garage/meta"

[data]
data_dir = "/var/lib/garage/data"

[network]
rpc_addr = "0.0.0.0:3901"
api_addr = "0.0.0.0:3900"

[s3_api]
api_bind_addr = "0.0.0.0:3900"
```

Adjust addresses to bind only to management VLAN if required.

---

## Step 4: Initialize Garage Cluster & Keys

```bash
# Initialize node identity and metadata
garage setup --config /etc/garage/config.toml

# Generate admin key (store securely)
garage -c /etc/garage/config.toml key generate --name admin

# Create Terraform user and keys
garage -c /etc/garage/config.toml user create terraform
garage -c /etc/garage/config.toml key generate --name terraform --user terraform

# Create bucket for Terraform state
garage -c /etc/garage/config.toml bucket create terraform-state --owner terraform
```

Enable bucket versioning for state recoverability:

```bash
garage -c /etc/garage/config.toml bucket versioning terraform-state enable
```

---

## Step 5: Create Systemd Service

### Service Account (optional but recommended)

```bash
sudo useradd --system --home /var/lib/garage --shell /usr/sbin/nologin garage
sudo chown -R garage:garage /etc/garage /var/lib/garage
```

### Unit File `/etc/systemd/system/garage.service`

```ini
[Unit]
Description=Garage Object Store
After=network-online.target
Wants=network-online.target

[Service]
User=garage
Group=garage
ExecStart=/usr/local/bin/garage server --config /etc/garage/config.toml
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```

Reload and enable:

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now garage
sudo systemctl status garage
```

---

## Step 6: Secure Networking & TLS (Optional but advised)

- Configure reverse proxy (nginx, Caddy) for HTTPS termination or enable Garage’s built-in TLS settings in `config.toml`.
- Restrict firewall: allow TCP 3900/3901 only from Terraform runners or management network.
- Rotate access keys regularly and store secrets in Vault or encrypted password manager.

---

## Step 7: Configure Terraform Backend

`backend.tf` example:

```hcl
terraform {
  backend "s3" {
    endpoint                  = "http://garage.mgmt.lan:3900"
    bucket                    = "terraform-state"
    key                       = "environments/prod/terraform.tfstate"
    region                    = "garage"
    access_key                = var.garage_access_key
    secret_key                = var.garage_secret_key
    skip_credentials_validation = true
    skip_metadata_api_check     = true
    force_path_style            = true
  }
}
```

Store credentials in Terraform variables (`terraform.tfvars` or environment variables) rather than inline.

Initialize and validate:

```bash
terraform init
terraform state pull
```

---

## Step 8: Validation Checklist

```bash
garage status                             # cluster health
garage bucket list                        # confirm terraform-state exists
systemctl status garage                   # service running
curl -I http://garage.mgmt.lan:3900       # HTTP 200 OK
terraform plan                            # backend reachable
```

Expected outcomes: Garage reports healthy node, bucket present, systemd service active, Terraform connects without error.

---

## Step 9: Maintenance & Scaling

- **Backups:** Use `garage export` or filesystem snapshots for `/var/lib/garage` . Test restores regularly.
- **Monitoring:** Aggregate logs with `journalctl -u garage`. Consider Prometheus exporter (community) for metrics.
- **Scaling:** For multi-node cluster, repeat setup and join nodes using `garage node add` commands per official docs.
- **Upgrades:** Stop service, replace binary with new release, run `garage migrate` if required, then restart.
- **Housekeeping:** Rotate keys, enforce least privilege, review bucket ACLs, prune old state versions if storage pressure grows.

---

## Practical Advice

- LXC deployments: enable nesting (`lxc config set <name> security.nesting true`), mount dedicated disk (`pct set <id> -mp0 <storage>`), and ensure AppArmor allows Garage binary.
- VM deployments: allocate ≥2 GB RAM, fast SSD storage, and snapshot before upgrades.
- Integrate with Consul/Nomad by registering Garage service for discovery and health checks if desired.

---

## Update Notice
Instructions accurate as of November 2025. Verify with official documentation before applying to production.

## Further Reading
- [Garage S3 Backend](https://garagehq.deuxfleurs.fr/documentation/terraform/)
- [Garage Container Guide](https://garagehq.deuxfleurs.fr/documentation/container/)
- Book: "Terraform: Up & Running" by Yevgeniy Brikman
- Book: "Infrastructure as Code" by Kief Morris
